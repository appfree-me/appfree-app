
## appfree-app Architecture

#### Overview

We receive events from Asterisk via Websocket and transmit commands via REST Api to Asterisk.
Websocket is only used to receive events and REST Api is only used to send commands reacting to these events.

#### Connection to `appfree-phone-server`

To use `appfree-app`, you must install `appfree-phone-server`. This provides a configured ready-to-use Asterisk instance which is used to connect us to the telephone network.

#### Swagger REST API

Swagger API connector is included as dependency `lelaurent/php-asterisk-swagger-api`.

Swagger API is autogenerated from Asterisk Swagger API definition. Since the autogeneration requires some manual rework, support for re-generating it is currently not included in the project.

#### Websocket Connection: Phpari

Forked from phpari project by ... (link: ...)


### State Machine

Every appfree app is backed by a state machine governing allowed inputs/outputs for every state.

### Modules


### Module States


### Coroutines



Each `appfree-app` state has a central coroutine called `run` which governs its part of the logic flow of the call. When the state is done, it can hangup the call (for end states) or transition away to a new state.

### Appfree Controller

AppfreeController is the central entrance point for every appfree instance and handles initialization and user authentication.

### DTOs

Appfree is written with type safety in mind, making it robust and reliable. This is why DTOs are used extensively for internal communication.

DTOs are versioned with the version number being present in the lowest subdirectory.

Types of DTOs used:




#### Commands

Command DTOs can be injected into the normal event flow of appfree states.
Module states can expect Command DTOs and act on them.  
Example: ReadDtmfStringFunctionCommand is expected by State ReadDtmfString. It waits for the requested Dtmf events from asterisk and then calls the callback provided in the Command.

#### Events

When an event is received by asterisk, a new Event DTO is created containing the data from this event. Only this DTO is used in further processing.

#### Expectations

Expectations can be yielded from a module state. When a new event arrives, it is only passed to the module state when the expectation matches.
Example: A `PlaybackFinishedExpectation` will ensure that the module state will receive a `PlaybackFinished` Event as next input.

#### Objects

DTOs which do not fit in the above categories.  
Usually used as parts of Event DTOs.



### Best practices

See README-contrib.md
