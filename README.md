# Appfree: A framework to provide smartphone-only services to the smartphone-less masses

Appfree is a framework allowing you to easily create IVR apps, e. g. apps which can be interacted with from a normal telephone or featurephone. It is based on a modern tech stack: PHP 8 and Laravel.

## Project Description

Are you feeling anxious when you notice you forgot your smartphone?
Are you feeling frustrated having to constantly update apps or having to reenter a password at the worst possible moment?

More and more things in daily life depend upon you having constant access to a charged, working smartphone with high speed data allowance.

Appfree is a project designed to relieve these feelings of frustration and anxiety and to deliver empowerment to everyday citizens.

Using appfree, you as a developer can create simple frontends for app only services which are normally usable only via a classic telephone or dumbphone.

The framework comes with a fully functional sample application for the city of Munich bike sharing service "MVG Rad", which is normally usable only via an Android/iOS app.  
With appfree, it is usable from every telephone.


## Preliminaries

All filesystem paths mentioned here are relative to the project root unless otherwise indicated.

## Project components

- ### appfree-app

Main repository for the app. Contains the framework and application logic for IVR apps.

- ### appfree-phone-server

Phone server backend providing connectivity to the phone network via Asterisk application. One instance of `appfree-phone-server` support connections by multiple appfree-app instances.

## Features

- ### Implemented features
  - Basic framework for implementing IVR apps
  - MVG Rad sample app
  - (##todo)

- ### To be implemented

  - SMS support
  - Voice input (speech to text)
  - TTS (text to speech) for dynamic announcements

## How to deploy

1. Build debian package for `appfree-app`:

Debian packages can be built from the repository. They are compatible with most Debian jammy?(##todo)
 based systems 

- `bin/build-deb`
- On target machine: `dpkg -i xy.deb`

2. Build debian package for `appfree-phone-server`
- `bin/build-deb`
- On target machine: `dpgk -i xz.deb`

Currently, configuration is hardcoded to expect both packages to be installed on the same machine. 

For development: Deployment for local instance is supported via shell script `bin/deploy`

## How to run

(##todo)

#### Run standalone

`./bin/run-app`

This runs appfree with Xdebug enabled. Use only for development.

#### Run as a system service

Use the systemctl commands provided in this document.


## Detailed information


### System integration

Appfree packages will create a user `appfree` in your system. Appfree doesn't need special privileges to run: it will run under the `appfree` user account. A separate `systemd` user instance will be started under this user account to manage the execution of the app. 

### Database setup

Appfree uses Mariadb as a database. Fill in DB_PASSWORD variable from .env.skel to configure access.

### Systemd

appfree is backed by systemd unit files which restart it automatically should the app crash.

Enable and start appfree with these commands after installing the debian packages: 

`systemctl --user enable appfree-app_local.service`
`systemctl --user start appfree-app_local.service`

Phone server is automatically started as a dependency. (##fixme)

Appfree doesn't need special privileges to run: Systemd unit files are installed in the `appfree` user home directory and a separate systemd instance running under the same user is used to manage the instance. 

### Watchdog 

A watchdog process regularly tests if the app is still available to users and sends an alert on failure. 

Configure alerts in file `todo`: 
...
SMTP username, password
alert-type: email (currently, only email is supported)

## appfree-app Architecture

#### Overview

We receive events from Asterisk via Websocket and transmit commands via REST Api to Asterisk.
Websocket is only used to receive events and REST Api is only used to send commands reacting to these events.

#### Connection to `appfree-phone-server`

To use `appfree-app`, you must install `appfree-phone-server`. This provides a configured ready-to-use Asterisk instance which is used to connect us to the telephone network.

#### Swagger REST API

Swagger API connector is included as dependency `lelaurent/php-asterisk-swagger-api`.

Swagger API is autogenerated from Asterisk Swagger API definition. Since the autogeneration requires some manual rework, support for re-generating it is currently not included in the project. 

#### Websocket Connection: Phpari

Forked from phpari project by ... (link: ...)


### State Machine

Every appfree app is backed by a state machine governing allowed inputs/outputs for every state. 

### Modules


### Module States


### Coroutines



Each `appfree-app` state has a central coroutine called `run` which governs its part of the logic flow of the call. When the state is done, it can hangup the call (for end states) or transition away to a new state. 

### Appfree Controller

AppfreeController is the central entrance point for every appfree instance and handles initialization and user authentication. 

### DTOs

Appfree is written with type safety in mind, making it robust and reliable. This is why DTOs are used extensively for internal communication.

DTOs are versioned with the version number being present in the lowest subdirectory.

Types of DTOs used: 




#### Commands

Command DTOs can be injected into the normal event flow of appfree states. 
Module states can expect Command DTOs and act on them.  
Example: ReadDtmfStringFunctionCommand is expected by State ReadDtmfString. It waits for the requested Dtmf events from asterisk and then calls the callback provided in the Command. 

#### Events

When an event is received by asterisk, a new Event DTO is created containing the data from this event. Only this DTO is used in further processing. 

#### Expectations

Expectations can be yielded from a module state. When a new event arrives, it is only passed to the module state when the expectation matches. 
Example: A `PlaybackFinishedExpectation` will ensure that the module state will receive a `PlaybackFinished` Event as next input.  

#### Objects

DTOs which do not fit in the above categories.  
Usually used as parts of Event DTOs.



### Best practices

See README-contrib.md

## MVG Rad example app, or: How to write an appfree module



### Audio Alerts

Alerts in the Demo app are currently static and generated with https://ttsmaker.com/.
To deploy them, add an MP3 or Ogg Opus file to `dist/usr/share/asterisk/sounds/en_US_f_Allison` in `phone-server` project and redeploy the `phone-server` project.





